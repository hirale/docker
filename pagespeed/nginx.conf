user nginx;
worker_processes 1;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;


events {
    worker_connections 1024;
}


http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
    '$status $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log none;

    sendfile on;
    #tcp_nopush     on;

    keepalive_timeout 65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;

	pagespeed on;

	# Needs to exist and be writable by nginx.  Use tmpfs for best performance.
	pagespeed DownstreamCachePurgeLocationPrefix http://varnish:6081;
	pagespeed Domain *.r5e.com;
	pagespeed FileCachePath /var/ngx_pagespeed_cache;
	pagespeed HonorCsp on;
	pagespeed LowercaseHtmlNames on;
	pagespeed PreserveUrlRelativity on;
	pagespeed EnableFilters make_show_ads_async;
	pagespeed EnableFilters make_google_analytics_async;
	pagespeed EnableFilters collapse_whitespace;
	pagespeed EnableFilters combine_css;
	pagespeed EnableFilters combine_javascript;
	pagespeed EnableFilters combine_heads;
	pagespeed EnableFilters dedup_inlined_images;
	pagespeed EnableFilters elide_attributes;
	pagespeed EnableFilters extend_cache;
	pagespeed EnableFilters convert_jpeg_to_webp;
	pagespeed EnableFilters convert_png_to_jpeg;
	pagespeed EnableFilters convert_to_webp_animated;
	pagespeed EnableFilters rewrite_images;
	pagespeed EnableFilters inline_google_font_css;
	pagespeed FetchHttps enable;
	pagespeed EnableFilters responsive_images,resize_images;
	pagespeed EnableFilters lazyload_images;
	pagespeed EnableFilters rewrite_javascript;
	pagespeed EnableFilters move_css_above_scripts;
	pagespeed EnableFilters move_css_to_head;
	pagespeed EnableFilters remove_comments;
	pagespeed EnableFilters remove_quotes;

    server {
        listen 80;

        server_name yescosplay.r5e.com;
        set $base /var/www/html;
        root $base/yescosplay/pub;

        access_log none;
        error_log /dev/stdout info;

        charset utf-8;
        index index.php;
        autoindex off;

		# Ensure requests for pagespeed optimized resources go to the pagespeed handler
		# and no extraneous headers get set.
		pagespeed MapOriginDomain "http://yescosplay.r5e.com" "https://yescosplay.r5e.com";
		pagespeed LoadFromFile "^https?://yescosplay.r5e.com/media/" "/var/www/html/yescosplay/media/";
		pagespeed LoadFromFile "^https?://yescosplay.r5e.com/js/" "/var/www/html/yescosplay/js/";
		pagespeed LoadFromFile "^https?://yescosplay.r5e.com/css/" "/var/www/html/yescosplay/css/";
		pagespeed LoadFromFile "^https?://yescosplay.r5e.com/skin/" "/var/www/html/yescosplay/skin/";

		location ~ "\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+" {
		add_header "" "";
		}
		location ~ "^/pagespeed_static/" { }
		location ~ "^/ngx_pagespeed_beacon$" { }

        location ^~ /app/ {
            deny all;
        }
        location ^~ /includes/ {
            deny all;
        }
        location ^~ /lib/ {
            deny all;
        }
        location ^~ /media/downloadable/ {
            deny all;
        }
        location ^~ /pkginfo/ {
            deny all;
        }
        location ^~ /report/config.xml {
            deny all;
        }
        location ^~ /var/ {
            deny all;
        }
        location /var/export/ {
            deny all;
        }

        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        location ~ \.php$ {
            expires off;
            # 404
            try_files $fastcgi_script_name =404;

            # default fastcgi_params
            include fastcgi_params;

            # fastcgi settings
            fastcgi_pass php-fpm:9000;
            fastcgi_index index.php;
            fastcgi_buffers 8 16k;
            fastcgi_buffer_size 32k;

            # fastcgi params
            fastcgi_param DOCUMENT_ROOT $realpath_root;
            fastcgi_param SCRIPT_FILENAME	$realpath_root$fastcgi_script_name;
            fastcgi_param PHP_ADMIN_VALUE	"open_basedir=$base/:/usr/lib/php/:/tmp/";

        }

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }
    }
}